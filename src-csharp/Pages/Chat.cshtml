@page
@model ChatModel
@{
    ViewData["Title"] = "Chat Assistant";
}

<div class="container-fluid">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Info:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-chat-dots"></i> Expense Management Chat Assistant</h2>
                    <small>Ask questions about expenses or request actions like creating or approving expenses</small>
                </div>
                <div class="card-body">
                    <div id="chatMessages" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="text-muted text-center py-5">
                            <i class="bi bi-chat-text" style="font-size: 3rem;"></i>
                            <p class="mt-2">Start a conversation by typing a message below</p>
                            <small>Example: "Show me all pending expenses" or "Create a new travel expense for £50"</small>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." />
                        <button class="btn btn-primary" id="sendButton" type="button">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> Try asking:
                            "What are my pending expenses?", "Create a meal expense for £25", "Approve expense #123"
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        function addMessage(message, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${isUser ? 'text-end' : 'text-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `d-inline-block p-2 rounded ${isUser ? 'bg-primary text-white' : 'bg-white border'}`;
            bubble.style.maxWidth = '70%';
            bubble.innerHTML = message.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(bubble);
            
            // Clear welcome message
            if (chatMessages.querySelector('.text-muted.text-center')) {
                chatMessages.innerHTML = '';
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, true);
            chatInput.value = '';
            sendButton.disabled = true;

            try {
                // Check if GenAI is configured
                const healthResponse = await fetch('/api/health');
                const healthData = await healthResponse.json();
                
                if (healthData.error) {
                    // GenAI not configured, provide dummy responses
                    addMessage('I apologize, but the AI chat assistant is not fully configured yet. The GenAI services need to be deployed. ' +
                              'To enable AI-powered chat, please run the deploy-with-chat.sh script.\n\n' +
                              'In the meantime, you can still use the web interface to manage expenses:\n' +
                              '• View expenses: Click "My Expenses" in the navigation\n' +
                              '• Add expense: Click "Add Expense"\n' +
                              '• Approve expenses: Click "Approve"\n' +
                              '• View API documentation: Click "API Docs"', false);
                } else {
                    // For now, provide intelligent mock responses based on keywords
                    const lowerMessage = message.toLowerCase();
                    
                    if (lowerMessage.includes('pending') || lowerMessage.includes('submitted')) {
                        const response = await fetch('/api/expenses/pending');
                        const data = await response.json();
                        
                        if (data.data && data.data.length > 0) {
                            let responseText = `I found ${data.data.length} pending expense(s):\n\n`;
                            data.data.slice(0, 3).forEach((exp, i) => {
                                responseText += `${i + 1}. ${exp.categoryName} - ${exp.formattedAmount} by ${exp.userName}\n`;
                            });
                            if (data.data.length > 3) {
                                responseText += `\n... and ${data.data.length - 3} more. Visit the Approve page to see all.`;
                            }
                            addMessage(responseText, false);
                        } else {
                            addMessage('There are no pending expenses at the moment.', false);
                        }
                    } else if (lowerMessage.includes('create') || lowerMessage.includes('add') || lowerMessage.includes('new')) {
                        addMessage('To create a new expense, please visit the "Add Expense" page from the navigation menu. ' +
                                 'You\'ll need to provide:\n• Amount\n• Date\n• Category (Travel, Meals, Supplies, etc.)\n• Description (optional)', false);
                    } else if (lowerMessage.includes('approve')) {
                        addMessage('To approve expenses, please visit the "Approve" page from the navigation menu. ' +
                                 'There you can review pending expenses and approve or reject them.', false);
                    } else if (lowerMessage.includes('help')) {
                        addMessage('I can help you with:\n' +
                                 '• Viewing pending expenses\n' +
                                 '• Navigating to create new expenses\n' +
                                 '• Finding the approval page\n' +
                                 '• Checking expense status\n\n' +
                                 'Full AI capabilities will be available after deploying GenAI services with deploy-with-chat.sh', false);
                    } else {
                        addMessage('I understand you want to: "' + message + '"\n\n' +
                                 'The full AI assistant functionality requires GenAI services. For now, you can:\n' +
                                 '• View expenses: Navigate to "My Expenses"\n' +
                                 '• Add expenses: Navigate to "Add Expense"\n' +
                                 '• Approve expenses: Navigate to "Approve"\n\n' +
                                 'To enable full AI chat, run: ./deploy-with-chat.sh', false);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, I encountered an error processing your request. Please try again.', false);
            }

            sendButton.disabled = false;
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
}
