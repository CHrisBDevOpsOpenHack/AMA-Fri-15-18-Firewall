@page
@model AddModel
@{
    ViewData["Title"] = "Add Expense";
}

<div class="container">
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Database Connection Issue:</strong> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="h4 mb-0">Add New Expense</h2>
                </div>
                <div class="card-body">
                    <form id="expenseForm">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (Â£)</label>
                            <input type="number" class="form-control" id="amount" step="0.01" min="0.01" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" required>
                                <option value="">Select a category...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3" maxlength="1000"></textarea>
                            <div class="form-text">Optional description of the expense</div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Save Expense</button>
                            <a href="/" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const result = await response.json();
                
                const select = document.getElementById('category');
                if (result.data && result.data.length > 0) {
                    result.data.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.categoryId;
                        option.textContent = cat.categoryName;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value,
                category: parseInt(document.getElementById('category').value),
                description: document.getElementById('description').value
            };
            
            try {
                const response = await fetch('/api/expenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Expense created successfully!');
                    window.location.href = '/';
                } else {
                    alert(result.message || 'Failed to create expense');
                }
            } catch (error) {
                console.error('Error creating expense:', error);
                alert('Failed to create expense');
            }
        });
        
        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();
        
        document.addEventListener('DOMContentLoaded', loadCategories);
    </script>
}
